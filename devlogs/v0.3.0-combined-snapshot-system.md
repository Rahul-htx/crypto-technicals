# DevLog v0.3.0 ‚Äî Combined Snapshot System

**Date**: August 19, 2025  
**Author**: Rahul Bijlani  
**Version**: 0.3.0  

---

## üéØ **Problem Statement**

The previous snapshot system had a critical flaw that became apparent during LLM integration testing:

**Issue**: When running multiple horizons (intraday + swing), the `latest_snapshot.json` file was being **overwritten** by each horizon pass. This caused:
- **Data loss**: Only the last horizon's data survived
- **Price confusion**: ETH showing $4,317 (daily close) when user expected $4,158 (hourly close)
- **LLM confusion**: Unable to access both timeframes for comprehensive analysis

**Root Cause**: Each horizon run completely replaced the snapshot file instead of updating its own section.

---

## üí° **Solution: Combined Snapshot Architecture**

### New File Structure
```json
{
  "meta": {
    "last_updated": "2025-08-19T22:25:21Z",
    "horizons_present": ["intraday", "swing"],
    "coins_tracked": ["ethereum", "bitcoin", "solana", ...]
  },
  "intraday": {
    "meta": { "granularity": "1h", "run_timestamp": "..." },
    "market_overview": { ... },
    "cross_coin": { ... },
    "coins": { ... },
    "news": { ... }
  },
  "swing": {
    "meta": { "granularity": "1d", "run_timestamp": "..." },
    "market_overview": { ... },
    "cross_coin": { ... },
    "coins": { ... },
    "news": { ... }
  }
}
```

### Key Benefits
1. **No Data Loss**: Each horizon updates only its own section
2. **Single File**: LLM loads one file, accesses any timeframe
3. **Data Preservation**: Running intraday preserves swing data (and vice versa)
4. **Backward Compatible**: Timestamped files still created for audit trail

---

## üîß **Implementation Details**

### Modified Components

#### 1. SnapshotExporter (`src/exporter/snapshot_exporter.py`)
**Before**: Single-horizon payload overwrites entire file
```python
def export(self, results, horizon):
    snapshot = build_snapshot(results)
    write_file(snapshot)  # ‚Üê Overwrites everything
```

**After**: Horizon-specific patching
```python
def export(self, results, horizon):
    combined_snapshot = load_existing_combined_snapshot()
    horizon_payload = build_horizon_payload(results)
    combined_snapshot[horizon] = horizon_payload  # ‚Üê Patch only this section
    write_combined_file(combined_snapshot)
```

#### 2. Freshness Detection Enhancement
Enhanced boundary detection to work per-horizon:
```python
def _determine_freshness_for_horizon(self, existing_horizon_data, now, granularity):
    # Check boundaries based on this horizon's last run, not global last run
    return self._determine_freshness(existing_horizon_data, now, granularity, ...)
```

#### 3. File Management
- **Combined latest**: `data/snapshots/latest_snapshot.json`
- **Horizon backups**: `data/snapshots/snapshot_intraday_2025-08-19T22-25-21Z.json`
- **Preserved structure**: Each horizon section maintains identical schema

### Smart Freshness Logic
The system still uses data boundary detection (not wall clock time):
- **1h data**: Updates when crossing hour boundaries
- **1d data**: Updates when crossing day boundaries
- **Force flags**: `--force-hourly`, `--force-daily` still work

---

## üìä **Validation & Testing**

### Test Scenarios Verified
1. **‚úÖ First run**: Both horizons populated correctly
2. **‚úÖ Intraday-only run**: Preserves existing swing data
3. **‚úÖ Swing-only run**: Preserves existing intraday data
4. **‚úÖ Boundary detection**: Only updates when meaningful time boundaries crossed
5. **‚úÖ File size**: ~20KB for 6 coins, 2 horizons (vs 100s of KB raw)

### Edge Case Resolution
**Scenario**: 11:55 PM ‚Üí 12:05 AM run
- **Before**: Might skip update (only 10 minutes elapsed)
- **After**: ‚úÖ Updates correctly (crossed hour + day boundary)

### Sample Output Validation
```bash
# Intraday ETH: $4,150.53 (latest 1h candle)
# Swing ETH: $4,317.28 (latest 1d candle)
# ‚úÖ Both values accessible, no confusion
```

---

## üöÄ **Performance Impact**

- **File size**: 2x larger (~20KB vs ~10KB) but still trivial for 200k context LLMs
- **Write performance**: Minimal impact (single JSON merge operation)
- **Read performance**: Improved (one file load vs multiple)
- **Memory usage**: Negligible increase

---

## üîÆ **Future Enhancements**

### Immediate Opportunities
1. **4h timeframe**: Easy to add as third horizon section
2. **News integration**: CryptoPanic feeds into shared news section
3. **LLM recommendations**: Agent can write back its analysis to dedicated section

### Architectural Extensions
```json
{
  "meta": { ... },
  "intraday": { ... },
  "swing": { ... },
  "weekly": { ... },           // Future: 1w data
  "news": { ... },             // Shared across horizons
  "llm_analysis": {            // AI agent output
    "signals": { ... },
    "confidence": { ... },
    "reasoning": "..."
  }
}
```

---

## üìã **Migration Notes**

### Breaking Changes
- **None**: Existing exports unchanged
- **Additive**: New snapshot system runs alongside existing outputs

### User Impact
- **CLI**: No changes required
- **Consumption**: Update LLM code to access `snapshot["intraday"]` vs `snapshot` directly
- **Files**: New snapshot directory created automatically

### Upgrade Path
1. Update code (automatic)
2. Run normal pipeline
3. New combined snapshots generated alongside existing files
4. Optionally update LLM integration to use combined files

---

## ‚úÖ **Acceptance Criteria Met**

1. **‚úÖ Combined structure**: All horizons in separate sections
2. **‚úÖ No data loss**: Multiple runs preserve all timeframe data
3. **‚úÖ Boundary logic**: Smart freshness detection per horizon
4. **‚úÖ Backward compatibility**: Timestamped files maintained
5. **‚úÖ LLM ready**: Structured access to all timeframes
6. **‚úÖ Production ready**: Validated with multiple test scenarios

---

**Status**: ‚úÖ **COMPLETED & DEPLOYED**  
**Next**: Integration with 5-minute + 30-minute scheduling system
